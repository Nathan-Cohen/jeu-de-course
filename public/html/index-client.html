<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Jeu multijoueur</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <script src="/socket/socket.io.js"></script>
    <script src="/lib/jquery-3.3.1.min.js"></script>

    <script>
    (function(window, io){
        window.addEventListener('DOMContentLoaded', function(){
            var socket = io();
            // creer un identifiant unique pour chaque utilisateur
            var idUnique = Math.floor(Math.random()*200);     
            var boolAnimation = true;            
            var monLeft = 0;

            // ecoute l'evenement du formulaire et envoie le username au serveur et l'id unique
            document.getElementById('monForm').addEventListener('submit', function(event){
                event.preventDefault();
                var username = document.getElementById('username').value;
                var password = document.getElementById('password').value;
                var tabAvatar = []
                    for(var i = 0; i < document.getElementsByClassName('avatar').length; i++){
                        if(document.getElementsByClassName('avatar')[i].checked){
                        avatar = document.getElementsByClassName('avatar')[i].id;
                        tabAvatar.push(avatar)
                        }
                    }
                    if(tabAvatar.length == 1){
                        socket.emit('name', {username: username, password: password, id: idUnique, avatar: avatar});                        
                    }else if (document.getElementsByClassName('avatar')){
                        // affiche la div joueur
                        var divjoueur = document.getElementById('joueur');
                            $(divjoueur).show('slow');
                            divjoueur.style.display = "block";
                            // affiche le message si l'utilisateur est déjà pris
                            document.getElementById('nomDuJoueur').innerHTML = "Séléctionner un Avatar";
                    }
                    
                
            });
            // recupere les données de connexion a la base 
            socket.on('connection', function (data) {
                if(data.connecter === true){
                    ////////////////////AFFICHAGE///////////////////
                    // affiche la div de jeu
                    var divJeu = document.getElementById('jeu');
                    $(divJeu).fadeIn('slow');                    
                    divJeu.style.display = "block";

                    // affiche la div du joueur
                    var divjoueur = document.getElementById('joueur');
                    $(divjoueur).fadeIn('slow');
                    divjoueur.style.display = "block";
                    document.getElementById('nomDuJoueur').innerHTML = "Bienvenue : <strong>" + data.username + "</strong>";

                    // cache la div de connexion 
                    var divConnexion = document.getElementById('divConnexion');
                    $(divConnexion).fadeOut(1000);
                    divConnexion.style.display = "none";

                    socket.emit('connecter', data)

                }
                else{
                    // affiche la div joueur
                    var divjoueur = document.getElementById('joueur');
                    $(divjoueur).show('slow');
                    divjoueur.style.display = "block";
                    // affiche le message si l'utilisateur est déjà pris ou si la parti est complete 
                    document.getElementById('nomDuJoueur').innerHTML = data.messageDeConnexion;  
                    
                }
            });
            

            socket.on('lancement', function(data){
                data.tableauDesJoueurs.forEach(element => {
                        // si le joueur n'existe pas 
                        if(document.getElementsByClassName('jeuDuJoueur' + element.id).length==0){                        
                            // creation de la div du joueur
                            var divTable = document.getElementById('jeuDesJoueurs');                    
                            var jeuDuJoueur = document.createElement("div");
                            jeuDuJoueur.className = "jeuDuJoueur" + element.id;
                            divTable.appendChild(jeuDuJoueur);  
                            
                            // creation du titre (login) du joueur
                            var divJeuDuJoueur = document.getElementsByClassName('jeuDuJoueur' + element.id);                                        
                            var divTitreJoueur = document.createElement("div");
                            divTitreJoueur.className = "titreJoueur" + element.id + " divTitreJoueurDuJoueur";
                            divTitreJoueur.innerHTML = '<h2>' + element.name + '</h2>';
                            divTitreJoueur.style.display = 'flex';
                            divJeuDuJoueur[0].appendChild(divTitreJoueur);
                            
                            // creer la div pour le joueur qui contient les cartes
                            var divCartesDuJoueur = document.createElement('div');
                            divCartesDuJoueur.className = "joueur" + element.id + " divJoueur";
                            divCartesDuJoueur.style.display = "inline-block";
                            divJeuDuJoueur[0].appendChild(divCartesDuJoueur);

                            // creer la div avatar du joueur  et ajoute l'img                   
                            var divAvatar = document.createElement('div');
                            divAvatar.className = "avatarJoueur" + element.id;
                            divAvatar.innerHTML = "<img width='20' src='../images/" + element.avatar  + ".png' alt=''>";
                            divAvatar.style.marginTop = '50px';
                            divAvatar.style.position = 'absolute';
                            divTitreJoueur.appendChild(divAvatar);
                        }
                    });
                
            });

            socket.on('pret', function(data){
                if(data.message == 'pret'){
                    if(data.connexion.tableauDesJoueurs.length == 2){
                        socket.emit('activeChrono', {idUnique: data.connexion.idUnique})
                    }
                    setTimeout(function(){
                        document.addEventListener('keydown', function(e){
                            if(e.keyCode == 32){  
                                if (boolAnimation){
                                    divCompteARebour.innerHTML = "" 
                                        avatar = document.getElementsByClassName('avatarJoueur' + data.connexion.idUnique);
                                        titreJoueur = document.getElementsByClassName('titreJoueur' + data.connexion.idUnique);    
                                        tempsEcoule = document.getElementById('spanChronometre');    
                                                                   
                                    anim = setInterval(function(){                
                                        monLeft = monLeft + 4;
                                        if(monLeft < 200){
                                            avatar[0].style.marginLeft = monLeft + 'px';                                       
                                            socket.emit('avance', {monLeft: monLeft, idUnique: data.connexion.idUnique});
                                        }else{
                                            divclique = document.getElementById('clique')
                                            divclique.style.display = 'none'
                                            socket.emit('gagnant', {idUnique: data.connexion.idUnique, tempsEcoule: tempsEcoule.innerHTML})
                                        }
                                    }, 25)
                                    arretAnim = setInterval(function(){
                                        clearInterval(anim)
                                        clearInterval(arretAnim)
                                    }, 25)
                                }
                                boolAnimation = false;
                            }
                        });

                        document.addEventListener('keyup', function(e){
                            if (e.keyCode === 32){
                            boolAnimation = true
                            clearInterval(anim)
                            }
                            
                        })
                    }, 3000)
                }
                else{
                    document.addEventListener('keyup', function(e){
                        // if(e.keyCode == 32){
                        //     alert('en attente du deuxieme joueur')
                        // }
                    });
                }
            });

            socket.on('chronometre', function(data){
                compteARebour = 3;
                    var tempsEcoule = 0;                    
                    divCompteARebour = document.getElementById('compteARebour')
                    divCompteARebour.innerHTML = compteARebour;
                    compte = setInterval(function(){
                        compteARebour--;
                        divCompteARebour.innerHTML = compteARebour;
                        if(compteARebour == 0){
                            clearInterval(compte)
                            divCompteARebour.innerHTML = "GO !"
                            divclique = document.getElementById('clique')
                            divclique.style.display = 'block'
                                    
                        }
                    }, 1000)
                var tempsEcoule = 0;          
                // active le chronometre
                function chronometreDepart(){
                    intervalId = window.setInterval(function(){
                        tempsEcoule++;
                        var tempsEcouleFormate = tempsEcoule;
                        $('#chronometre span').html(tempsEcouleFormate);
                    }, 1000);
                };                          
                
                chronometreDepart();
            })

            socket.on('result', function(data){ 
                divCompteARebour = document.getElementById('compteARebour')                
                titreJoueur = document.getElementsByClassName('titreJoueur' + data.idUnique);                   
                divCompteARebour.innerHTML = titreJoueur[0].children[0].innerHTML + " a gagner la parti !"
                divclique = document.getElementById('clique')
                divclique.style.display = 'none'
                // desactive le chronometre
                function chronometreArret(){
                    window.clearInterval(intervalId);
                }
                chronometreArret();
            });

            socket.on('caracPerso', function(data){
                data.forEach(function(elementC){
                    avatar = document.getElementsByClassName('avatarJoueur' + elementC.idUnique);
                    avatar[0].style.marginLeft = elementC.monLeft + 'px';                   
                });

            });

            socket.on('deconnection', function(){
                console.log('un joueur deconnecter')
            })


            ////////////////PARTI MENU/////////////////
            // affiche les regles du jeu
            var reglesDuJeu = document.getElementById('reglesDuJeu');
            reglesDuJeu.addEventListener('click', function(){
                var monForm = document.getElementById('monForm');
                monForm.style.display = 'none';
                var afficheRegleDuJeu = document.getElementById('afficheRegleDuJeu')
                afficheRegleDuJeu.style.display = 'block'
                var divScoresDesJoueurs = document.getElementById('divScoresDesJoueurs')
                divScoresDesJoueurs.style.display = 'none'
                
                
            });
            // affiche le scores des joueurs            
            var scoresDesJoueurs = document.getElementById('scoresDesJoueurs');
            scoresDesJoueurs.addEventListener('click', function(){
                var monForm = document.getElementById('monForm');
                monForm.style.display = 'none';
                afficheRegleDuJeu.style.display = 'none'                
                socket.emit('demandeLesScoresDesJoueurs', {test: 'test'})
                socket.on('afficheLesScoresDesJoueurs', function(data){
                    var afficheScoresDesJoueurs = document.getElementById('afficheScoresDesJoueurs')                
                    $(afficheScoresDesJoueurs).empty();
                    divScoresDesJoueurs.style.display = 'block'
                    for(var i=0; i<data.length; i++){
                        if(data[i].temp){
                            $(afficheScoresDesJoueurs).append("<strong>User : </strong>" + data[i].username + "<strong> Temps : </strong>" + data[i].temp + "<br><br>")
                        }
                    }
                });
            });

            // affiche la parti connexion
            var connexionAuJeu = document.getElementById('connexion');            
            connexionAuJeu.addEventListener('click', function(){
                var monForm = document.getElementById('monForm');
                monForm.style.display = 'block';
                divScoresDesJoueurs.style.display = 'none'
                afficheRegleDuJeu.style.display = 'none'                
                
            })
            
        });

    })(window, io);
    </script>
</head>
<body>
    <div id="divConnexion">
        <h1>Jeu de course</h1>
        
        <ul id="menu">
            <li>
                <button id="connexion" class="buttonMenu">Connexion</button>
            </li>
            <li>
                <button id="scoresDesJoueurs" class="buttonMenu">Scores</button>
            </li>
            <li>
                <button id="reglesDuJeu" class="buttonMenu">Règles du jeu</button>
            </li>
        </ul>

        <!-- formulaire de connexion -->
        <form id="monForm">
            <div>
                <p>
                <label>Login :</label>
                    <input type="text" name="username" id="username" placeholder="login.." required>
                <label>Mot de passe :</label>
                    <input type="password" name="password" id="password" placeholder="password.." required>
                <!-- <label>Avatar :</label> -->
                <input type="radio" name="radio-freddy" id="freddy" class="avatar" />
                <label for="freddy"><img width="20" src="../images/freddy.png" alt="" /></label>

                <input type="radio" name="radio-freddy" id="batman" class="avatar" />
                <label for="batman"><img width="20" src="../images/batman.png" alt="" /></label>

                <input type="radio" name="radio-freddy" id="darkvador" class="avatar" />
                <label for="darkvador"><img width="20" src="../images/darkvador.png" alt="" /></label>

                <input type="radio" name="radio-freddy" id="luke" class="avatar" />
                <label for="luke"><img width="20" src="../images/luke.png" alt="" /></label>
                </p>
            </div>
            <input type="submit">
        </form>
        <!-- parti connexion -->
        <div id="joueur">
            <span id="nomDuJoueur"></span>
        </div>
    </div>    

    <!-- parti jeu -->
    <div id="jeu">

        <!-- div de depart -->
    <div id="depart">Depart</div>

    <div id="resultat"></div>

    <div id="ligneArriver"></div>  
    
    <div id="chronometre"><span id="spanChronometre"></span> Secondes</div>    
    
    <!-- affiche les cartes tirée -->
    <div id="carte">

        <div id="jeuDesJoueurs">

        </div>            
    </div>
    </div>


    <div id="compteARebour"></div>

    <div id="clique">Clique !</div>
    


    <!-- PARTI SCORES DES JOUEURS -->
    <div id="divScoresDesJoueurs">
        <h3>Liste des scores des joueurs</h3>
        <div id="afficheScoresDesJoueurs">

        </div>
    </div>
    
    
    
    <!-- PARTI REGLES DU JEU -->
    <div id="afficheRegleDuJeu">
        <div id="listeDuScoreDesJoueurs" style="
            width:  70%;
            margin: auto;
            font-family:  sans-serif;
            ">
                <h2>Règles du jeu</h2>
            
                <strong>But du jeu</strong>
                <p>
                Après avoir reçu deux cartes, le joueur tire des cartes pour s’approcher de la valeur 21 sans la dépasser. Le but du joueur est de battre le croupier en obtenant un total de points supérieur à celui-ci ou en voyant ce dernier dépasser 21. Chaque joueur joue contre le croupier, qui représente la banque, ou le casino, et non contre les autres joueurs.
                
                Valeurs des cartes
                Chaque carte numérotée de 2 à 10 a sa valeur nominale (égale au numéro sur la carte)
                Les valets, les dames et les rois (les figures), ont une valeur de 10 points
                L’As vaut 1 point ou 11 points, au choix du joueur
                <ul>
                    1 : La distribution des cartes initiale
                    Le croupier distribue deux cartes visibles à chaque joueur et ne se distribue qu’une seule carte, découverte (règle européenne sans carte cachée).
                    
                    Cas du blackjack
                    Il y a blackjack lorsque le joueur reçoit 2 cartes totalisant une valeur de 21 lors de la donne initiale (un As et un 10 ou une figure). Si un joueur possède un blackjack, le croupier paiera le joueur immédiatement à 3:2 (1,5 fois la mise initiale) avant de continuer avec les autres joueurs de la table. Le joueur ayant un blackjack remportera une fois et demi sa mise initiale si le croupier n’a pas de blackjack après distribution de la seconde carte au croupier. En cas de balckjack chez le joueur et chez le croupier, la main sera déclarée nulle et aucune somme ne sera échangée.
                </ul>
                
                <ul>
                    2 : Le tour des joueurs
                    Le croupier demande au joueur s’il souhaite une carte supplémentaire. Vous pouvez tirer (demander une carte) autant de fois que vous le souhaitez, tant que vous ne dépassez pas 21. Lorsque vous avez un total que vous trouvez satisfaisant, vous faites savoir au croupier que vous restez, et le jeu continue avec le joueur suivant. Quelques options supplémentaires existent, voici un récapitulatif de toutes les actions possibles au blackjack :
                    
                    Tirer une carte (en anglais : hit) : vous souhaitez prendre une autre carte, que le croupier vous distribue. Dans les parties où les cartes sont distribuées au sabot, n’oubliez pas d’indiquer au croupier d’un signe de la main que vous voulez prendre une carte ou dites "Carte". Si le joueur tire et qu’il dépasse 21, il perd sa mise.
                    
                    Rester (en anglais : stand) : vous restez si vous êtes satisfait de votre main, que le total est suffisant ; vous ne voulez pas de carte supplémentaire. Indiquez au croupier que vous êtes servi(e), en le lui signifiant d’un geste (horizontal) de la main (au-dessus de vos cartes) ou en disant "Reste".
                </ul>
                
                <ul>
                    3 : Le tour du croupier
                    Le croupier est le dernier joueur à agir. Le croupier ne se sert qu’une carte, et se sert la seconde à la fin du tour des joueurs. Le croupier continue de jouer sa main comme tout joueur après le tour des joueurs. Si le croupier fait blackjack, il ramasse toutes les mises. Le croupier doit continuer de tirer jusqu’à qu’il obtienne une valeur d’au moins 17, il restera alors.
                    
                    Si le croupier saute, c’est-à-dire dépasse 21, tous les joueurs qui sont encore en lice gagnent. Sinon, les joueurs qui ont un total supérieur à celui du croupier gagnent et les joueurs qui ont un total inférieur perdent. En cas d’égalité, la mise du joueur est remboursée (l’argent ne change pas de main).
                </ul>
                
                Une fois que toutes les mains ont été payées ou que les mises ont été encaissées, une nouvelle donne peut avoir lieu.
                </p>
            </div>
    </div>
</body>
</html>